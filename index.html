<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrackingMe ğŸ†</title>
<link rel="apple-touch-icon" href="logo.svg">
<link rel="icon" type="image/svg+xml" href="logo.svg">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="TrackingMe">
<meta name="theme-color" content="#1a7a3f">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet">
<style>
  :root {
    --g1:#1a7a3f; --g2:#2ecc71; --g3:#a8f0c6;
    --g4:#d4fae8; --g5:#f0fff7; --white:#ffffff;
    --dark:#0f2419; --mid:#2d5a3d; --gray:#8aab96;
    --light:#e8f5ee; --accent:#ff6b35; --yellow:#ffd166;
    --radius:18px; --shadow:0 4px 24px rgba(26,122,63,0.13);
  }
  * { box-sizing:border-box; margin:0; padding:0; }
  html { font-size:18px; }
  body { font-family:'Nunito',sans-serif; background:var(--g5); color:var(--dark); min-height:100vh; overflow-x:hidden; }
  h1,h2,h3 { font-family:'Fredoka One',cursive; }

  /* â”€â”€ TOPBAR â”€â”€ */
  .topbar {
    background:var(--g1); color:white;
    padding:18px 22px 15px;
    display:flex; align-items:center; justify-content:space-between;
    position:sticky; top:0; z-index:100;
    box-shadow:0 2px 16px rgba(0,0,0,0.18);
  }
  .topbar h1 { font-size:1.8rem; letter-spacing:.5px; }
  .year-btn {
    background:rgba(255,255,255,0.18); border:2px solid rgba(255,255,255,0.4);
    color:white; font-family:'Fredoka One',cursive; font-size:1.15rem;
    padding:8px 20px; border-radius:30px; cursor:pointer; transition:background .2s;
  }
  .year-btn:hover { background:rgba(255,255,255,0.3); }

  /* â”€â”€ TABS â”€â”€ */
  .tabs {
    display:flex; background:var(--white); border-bottom:2px solid var(--g3);
    position:sticky; top:65px; z-index:99; overflow-x:auto;
  }
  .tabs::-webkit-scrollbar { display:none; }
  .tab {
    flex:1; min-width:80px; padding:13px 8px; text-align:center;
    font-weight:800; font-size:.88rem; color:var(--gray);
    cursor:pointer; border-bottom:3px solid transparent; transition:all .2s; white-space:nowrap;
  }
  .tab.active { color:var(--g1); border-bottom-color:var(--g1); }
  .tab .ti { font-size:1.3rem; display:block; margin-bottom:2px; }

  /* â”€â”€ PAGES â”€â”€ */
  .page { display:none; padding:18px; max-width:600px; margin:0 auto; padding-bottom:100px; }
  .page.active { display:block; }

  /* â”€â”€ CARDS â”€â”€ */
  .card { background:white; border-radius:var(--radius); padding:20px; margin-bottom:16px; box-shadow:var(--shadow); }
  .card-title { font-size:1.15rem; color:var(--mid); margin-bottom:14px; display:flex; align-items:center; gap:8px; }

  /* â”€â”€ ACTIVITY GRID â”€â”€ */
  .activity-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:14px; }
  .act-card {
    background:var(--g5); border-radius:16px; padding:16px;
    border:2px solid transparent; transition:all .2s; position:relative;
    min-height:160px;
  }

  /* streak badges in top-left corner */
  .act-streaks {
    position:absolute; top:10px; left:10px;
    display:flex; flex-direction:column; gap:3px;
  }
  .streak-pill {
    display:inline-flex; align-items:center; gap:3px;
    font-size:.72rem; font-weight:900;
    padding:2px 7px; border-radius:99px;
    line-height:1.3;
  }
  .streak-pill.fire   { background:#fff3e0; color:#e65100; }
  .streak-pill.trophy { background:#fffde7; color:#f57f17; }
  .streak-pill.bomb   { background:#fce4ec; color:#c62828; }

  .act-card .act-icon { font-size:2rem; margin-top:2px; display:block; text-align:right; }
  .act-card .act-name { font-weight:800; font-size:.92rem; margin:6px 0 2px; color:var(--mid); }
  .act-card .act-count { font-family:'Fredoka One',cursive; font-size:1.9rem; color:var(--g1); line-height:1.1; }
  .act-card .act-goal { font-size:.78rem; color:var(--gray); margin-bottom:6px; }
  .act-card .act-bar-wrap { background:var(--g4); border-radius:99px; height:7px; overflow:hidden; }
  .act-card .act-bar { background:linear-gradient(90deg,var(--g1),var(--g2)); border-radius:99px; height:100%; transition:width .6s cubic-bezier(.34,1.56,.64,1); }
  .act-card .act-pct-row {
    display:flex; justify-content:space-between; align-items:center; margin-top:5px;
  }
  .act-card .act-pct-row span:first-child { font-size:.75rem; color:var(--gray); font-weight:700; }
  .act-card .act-pct-row span:last-child  { font-size:.8rem; font-weight:900; color:var(--g1); }

  /* â”€â”€ FAB â”€â”€ */
  .log-fab {
    position:fixed; bottom:26px; right:22px; background:var(--g1); color:white;
    border:none; width:66px; height:66px; border-radius:50%; font-size:2rem;
    cursor:pointer; box-shadow:0 6px 24px rgba(26,122,63,.45);
    z-index:200; transition:transform .2s,box-shadow .2s;
    display:flex; align-items:center; justify-content:center;
  }
  .log-fab:hover { transform:scale(1.1); }

  /* â”€â”€ MODAL â”€â”€ */
  .modal-overlay {
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);
    z-index:300; align-items:flex-end; justify-content:center;
  }
  .modal-overlay.open { display:flex; }
  .modal {
    background:white; border-radius:24px 24px 0 0;
    padding:26px 22px 40px; width:100%; max-width:600px;
    animation:slideUp .3s ease; max-height:92vh; overflow-y:auto; position:relative;
  }
  @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
  .modal-title { font-size:1.4rem; margin-bottom:4px; color:var(--g1); }
  .modal-date { font-size:.95rem; font-weight:700; color:var(--gray); margin-bottom:18px; }
  .activity-btn-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:20px; }
  .act-btn {
    border:2px solid var(--g3); background:var(--g5); border-radius:14px; padding:14px 8px;
    text-align:center; cursor:pointer; font-family:'Nunito',sans-serif;
    font-weight:800; font-size:.88rem; color:var(--mid); transition:all .15s;
  }
  .act-btn .abi { font-size:1.6rem; display:block; margin-bottom:4px; }
  .act-btn.selected { border-color:var(--g1); background:var(--g3); color:var(--g1); }
  .weight-row { display:flex; gap:12px; align-items:center; margin-bottom:18px; }
  .weight-input {
    flex:1; border:2px solid var(--g3); border-radius:12px; padding:12px 16px;
    font-family:'Nunito',sans-serif; font-size:1.1rem; font-weight:700;
    color:var(--dark); outline:none;
  }
  .weight-input:focus { border-color:var(--g1); }
  .weight-label { font-weight:700; color:var(--gray); font-size:.95rem; white-space:nowrap; }
  .modal-save {
    width:100%; background:var(--g1); color:white; border:none;
    border-radius:14px; padding:16px; font-family:'Fredoka One',cursive;
    font-size:1.3rem; cursor:pointer; transition:background .2s;
  }
  .modal-save:hover { background:var(--mid); }
  .modal-close-btn {
    position:absolute; top:18px; right:20px; background:var(--light); border:none;
    width:36px; height:36px; border-radius:50%; font-size:1.2rem; cursor:pointer;
    display:flex; align-items:center; justify-content:center; color:var(--gray);
  }

  /* â”€â”€ CALENDAR â”€â”€ */
  .cal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
  .cal-nav {
    background:var(--g4); border:none; width:46px; height:46px; border-radius:50%;
    font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center;
    color:var(--g1); font-weight:900; transition:background .15s;
  }
  .cal-nav:hover { background:var(--g3); }
  .cal-month-title { font-size:1.4rem; color:var(--g1); }
  .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
  .cal-day-name { text-align:center; font-size:.8rem; font-weight:800; color:var(--gray); padding:6px 0; }
  .cal-day {
    aspect-ratio:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
    border-radius:12px; cursor:pointer; transition:background .15s;
    position:relative; padding:3px; min-height:54px;
  }
  .cal-day:hover:not(.empty) { background:var(--g4); }
  .cal-day.today { background:var(--g3); color:var(--g1); font-weight:900; }
  .cal-day.has-data { background:var(--g2); color:white; }
  .cal-day.empty { cursor:default; }
  .cal-day .day-num { font-size:.9rem; font-weight:800; line-height:1; }
  .cal-day .day-icons { display:flex; gap:1px; flex-wrap:wrap; justify-content:center; margin-top:2px; font-size:.7rem; line-height:1; max-width:100%; }
  .cal-day .day-wlbl { font-size:.58rem; color:var(--accent); font-weight:800; margin-top:2px; line-height:1; }
  .cal-day.has-data .day-wlbl { color:var(--yellow); }

  /* â”€â”€ WEIGHT â”€â”€ */
  .weight-chart-wrap { overflow-x:auto; padding-bottom:8px; }
  .weight-legend { display:flex; gap:14px; flex-wrap:wrap; margin-bottom:14px; }
  .wleg-item { display:flex; align-items:center; gap:6px; font-size:.8rem; font-weight:700; }
  .wleg-dot { width:16px; height:5px; border-radius:99px; }

  /* â”€â”€ HISTORY â”€â”€ */
  .hist-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .hist-label { font-size:.9rem; font-weight:700; display:flex; align-items:center; gap:6px; min-width:95px; }
  .hist-val { font-size:.88rem; font-weight:800; color:var(--mid); min-width:52px; text-align:right; }
  .hist-bar-wrap { flex:1; height:8px; background:var(--g4); border-radius:99px; margin:0 10px; overflow:hidden; }
  .hist-bar { height:100%; border-radius:99px; transition:width .5s; }

  /* â”€â”€ MISC â”€â”€ */
  .swipe-nav { display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:12px; }
  .swipe-arrow {
    background:var(--g4); border:none; width:40px; height:40px; border-radius:50%;
    font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center;
    color:var(--g1); font-weight:900; transition:background .15s;
  }
  .swipe-arrow:hover { background:var(--g3); }
  .swipe-label { font-family:'Fredoka One',cursive; font-size:1.1rem; color:var(--mid); min-width:90px; text-align:center; }
  .empty-state { text-align:center; padding:36px 0; color:var(--gray); font-weight:700; font-size:1rem; }
  .empty-state .es-icon { font-size:2.8rem; margin-bottom:10px; }
</style>
</head>
<body>

<div class="topbar">
  <h1>TrackingMe ğŸ†</h1>
  <button class="year-btn" id="yearSwitchBtn">2026 â–¾</button>
</div>

<div class="tabs">
  <div class="tab active" data-tab="home"><span class="ti">ğŸ </span>Inicio</div>
  <div class="tab" data-tab="calendar"><span class="ti">ğŸ“…</span>Calendario</div>
  <div class="tab" data-tab="weight"><span class="ti">âš–ï¸</span>Peso</div>
  <div class="tab" data-tab="history"><span class="ti">ğŸ“Š</span>Historial</div>
</div>

<!-- HOME -->
<div class="page active" id="page-home">
  <div class="card">
    <div class="card-title">ğŸ¯ Metas <span id="homeYear"></span></div>
    <div class="activity-grid" id="activityGrid"></div>
  </div>
</div>

<!-- CALENDAR -->
<div class="page" id="page-calendar">
  <div class="card">
    <div class="cal-header">
      <button class="cal-nav" id="calPrev">â—€</button>
      <h2 class="cal-month-title" id="calTitle"></h2>
      <button class="cal-nav" id="calNext">â–¶</button>
    </div>
    <div class="cal-grid" id="calGrid"></div>
  </div>
</div>

<!-- WEIGHT -->
<div class="page" id="page-weight">
  <div class="card">
    <div class="card-title">âš–ï¸ EvoluciÃ³n de peso â€” Historial completo</div>
    <div class="weight-legend">
      <div class="wleg-item"><div class="wleg-dot" style="background:#2ecc71"></div>Ã“ptimo (&lt;71 kg)</div>
      <div class="wleg-item"><div class="wleg-dot" style="background:#1a7a3f"></div>Normal (72â€“77 kg)</div>
      <div class="wleg-item"><div class="wleg-dot" style="background:#f39c12"></div>AtenciÃ³n (78 kg)</div>
      <div class="wleg-item"><div class="wleg-dot" style="background:#e74c3c"></div>Alerta (&gt;78 kg)</div>
    </div>
    <div class="weight-chart-wrap">
      <canvas id="weightChart" height="240"></canvas>
    </div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“‹ Todos los registros</div>
    <div id="weightList"></div>
  </div>
</div>

<!-- HISTORY -->
<div class="page" id="page-history">
  <div class="card">
    <div class="card-title">ğŸ“Š Comparativa anual</div>
    <div class="swipe-nav">
      <button class="swipe-arrow" id="hYearPrev">â—€</button>
      <span class="swipe-label" id="hYearLabel"></span>
      <button class="swipe-arrow" id="hYearNext">â–¶</button>
    </div>
    <div id="historyContent"></div>
  </div>
</div>

<!-- FAB -->
<button class="log-fab" id="fabBtn">ï¼‹</button>

<!-- LOG MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <button class="modal-close-btn" id="modalClose">âœ•</button>
    <h2 class="modal-title">âœï¸ Registrar dÃ­a</h2>
    <div class="modal-date" id="modalDate"></div>
    <div class="activity-btn-grid" id="modalActGrid"></div>
    <div class="weight-row">
      <input type="number" step="0.1" class="weight-input" id="weightInputModal" placeholder="Ej: 74.5">
      <span class="weight-label">âš–ï¸ kg (opcional)</span>
    </div>
    <button class="modal-save" id="modalSave">Guardar ğŸ’¾</button>
  </div>
</div>

<!-- YEAR MODAL -->
<div class="modal-overlay" id="yearModal">
  <div class="modal">
    <button class="modal-close-btn" id="yearModalClose">âœ•</button>
    <h2 class="modal-title">ğŸ—“ï¸ Cambiar aÃ±o</h2>
    <div id="yearBtnList" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ACTIVITIES = [
  { id:'workout',      name:'Workout',    icon:'ğŸ‹ï¸' },
  { id:'running',      name:'Running',    icon:'ğŸƒ' },
  { id:'bici',         name:'Bici',       icon:'ğŸš´' },
  { id:'lectura',      name:'Lectura',    icon:'ğŸ“š' },
  { id:'meditacion',   name:'MeditaciÃ³n', icon:'ğŸ§˜' },
  { id:'yoga',         name:'Yoga',       icon:'ğŸŒ€' },
  { id:'kegel',        name:'Kegel',      icon:'ğŸ©²' },
  { id:'flexibilidad', name:'Flexibil.',  icon:'ğŸ¤¸' },
  { id:'basket',       name:'Basket',     icon:'ğŸ€' },
  { id:'skate',        name:'Skate',      icon:'ğŸ›¹' },
];
const GOALS = {
  2026:{ workout:100,running:30,bici:20,lectura:30,meditacion:50,yoga:15,kegel:50,flexibilidad:30,basket:15,skate:10 },
  2025:{ workout:100,running:30,kegel:100,lectura:30 },
  2024:{ workout:150,running:50,kegel:50 },
};
const HIST = {
  2024:{ workout:110,running:14,kegel:29 },
  2025:{ workout:50,running:15,kegel:50,lectura:20 },
};
const WEIGHT_INIT = [
  {date:'2024-01-10',kg:74},{date:'2024-02-05',kg:71},{date:'2024-02-28',kg:71.5},
  {date:'2024-03-15',kg:70.8},{date:'2024-04-13',kg:69.7},{date:'2024-09-02',kg:77},
  {date:'2024-10-10',kg:78},{date:'2024-12-15',kg:76},{date:'2024-12-20',kg:76},
  {date:'2025-03-20',kg:74.5},{date:'2025-11-28',kg:82},{date:'2026-01-03',kg:78},
];

const KD='mytracker_days', KW='mytracker_weight';
const loadDays=()=>{try{return JSON.parse(localStorage.getItem(KD))||{}}catch{return{}}};
const saveDays=d=>localStorage.setItem(KD,JSON.stringify(d));
const loadWeights=()=>{
  const s=localStorage.getItem(KW);
  if(s){try{return JSON.parse(s)}catch{}}
  localStorage.setItem(KW,JSON.stringify(WEIGHT_INIT));
  return WEIGHT_INIT;
};
const saveWeights=w=>localStorage.setItem(KW,JSON.stringify(w));

let days=loadDays(), weights=loadWeights();
let activeYear=2026, calYear=2026, calMonth=new Date().getMonth();
let hYear=2026, modalDate=null;

const pad=n=>String(n).padStart(2,'0');
const dateStr=(y,m,d)=>`${y}-${pad(m+1)}-${pad(d)}`;
const todayStr=()=>{const n=new Date();return dateStr(n.getFullYear(),n.getMonth(),n.getDate());};
const MONTHS_ES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const MONTHS_SHORT=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];

function countYear(actId,year){
  if(year>=2026) return Object.entries(days).filter(([k,v])=>k.startsWith(year+'-')&&v.includes(actId)).length;
  return (HIST[year]&&HIST[year][actId])||0;
}

// â”€â”€ STREAK CALCULATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns ISO week string "YYYY-Www" for a date string "YYYY-MM-DD"
function isoWeek(dateS){
  const d=new Date(dateS+'T00:00:00');
  const jan4=new Date(d.getFullYear(),0,4);
  const startOfWeek1=new Date(jan4);
  startOfWeek1.setDate(jan4.getDate()-(jan4.getDay()||7)+1);
  const diff=d-startOfWeek1;
  const week=Math.floor(diff/(7*86400000))+1;
  let yr=d.getFullYear();
  if(week<1){
    // belongs to last year's last week
    const dec28=new Date(yr-1,11,28);
    return isoWeek(dateStr(yr-1,11,dec28.getDate()));
  }
  return `${yr}-W${pad(week)}`;
}

function getActivityStreaks(actId){
  // Get all dates for this activity, sorted ascending
  const actDates = Object.entries(days)
    .filter(([k,v])=>v.includes(actId))
    .map(([k])=>k)
    .sort();

  // ğŸ”¥ Daily streak â€” consecutive days ending today or yesterday
  let fireStreak=0;
  const td=new Date(todayStr()+'T00:00:00');
  for(let i=0;i<365;i++){
    const check=new Date(td); check.setDate(td.getDate()-i);
    const s=dateStr(check.getFullYear(),check.getMonth(),check.getDate());
    if((days[s]||[]).includes(actId)) fireStreak++;
    else break;
  }

  // Build week map: week -> count of days
  const weekMap={};
  actDates.forEach(d=>{
    const w=isoWeek(d);
    weekMap[w]=(weekMap[w]||0)+1;
  });

  const allWeeks=Object.keys(weekMap).sort();

  // ğŸ† Trophy â€” consecutive weeks with â‰¥1 session, ending on current/last week
  let trophyStreak=0;
  const curWeek=isoWeek(todayStr());
  // find streak ending at curWeek
  let w=curWeek;
  while(weekMap[w]>=1){
    trophyStreak++;
    // go back one week
    const [wy,wn]=w.split('-W').map(Number);
    let prevW=wn-1, prevY=wy;
    if(prevW<1){ prevY--; prevW=isoWeeksInYear(prevY); }
    w=`${prevY}-W${pad(prevW)}`;
  }

  // ğŸ’£ Bomb â€” consecutive weeks with â‰¥3 sessions, ending on current/last week
  let bombStreak=0;
  w=curWeek;
  while((weekMap[w]||0)>=3){
    bombStreak++;
    const [wy,wn]=w.split('-W').map(Number);
    let prevW=wn-1, prevY=wy;
    if(prevW<1){ prevY--; prevW=isoWeeksInYear(prevY); }
    w=`${prevY}-W${pad(prevW)}`;
  }

  return { fire:fireStreak, trophy:trophyStreak, bomb:bombStreak };
}

function isoWeeksInYear(y){
  // A year has 53 weeks if Dec 28 is a Thursday
  const dec28=new Date(y,11,28);
  const dow=dec28.getDay()||7;
  return dow===4 ? 53 : 52;
}

// â”€â”€ ZONE COLORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getZoneColor(kg){
  if(kg<71)  return '#2ecc71';
  if(kg<=77) return '#1a7a3f';
  if(kg<=78) return '#f39c12';
  return '#e74c3c';
}
function getZoneName(kg){
  if(kg<71)  return 'Ã“ptimo';
  if(kg<=77) return 'Normal';
  if(kg<=78) return 'AtenciÃ³n';
  return 'Alerta';
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('page-'+t.dataset.tab).classList.add('active');
    if(t.dataset.tab==='calendar') renderCalendar();
    if(t.dataset.tab==='weight')   renderWeight();
    if(t.dataset.tab==='history')  renderHistory();
  });
});

// â”€â”€ YEAR SWITCHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('yearSwitchBtn').addEventListener('click',()=>{
  document.getElementById('yearModal').classList.add('open');
  const list=document.getElementById('yearBtnList');
  list.innerHTML='';
  [2024,2025,2026].forEach(y=>{
    const b=document.createElement('button');
    b.textContent=y;
    b.style.cssText=`font-family:'Fredoka One',cursive;font-size:1.2rem;padding:12px 28px;border-radius:12px;border:2px solid ${y===activeYear?'var(--g1)':'var(--g3)'};background:${y===activeYear?'var(--g1)':'var(--g5)'};color:${y===activeYear?'white':'var(--mid)'};cursor:pointer;`;
    b.addEventListener('click',()=>{
      activeYear=y; calYear=y; calMonth=0;
      document.getElementById('yearSwitchBtn').textContent=y+' â–¾';
      document.getElementById('yearModal').classList.remove('open');
      renderHome();
    });
    list.appendChild(b);
  });
});
document.getElementById('yearModalClose').addEventListener('click',()=>document.getElementById('yearModal').classList.remove('open'));

// â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHome(){
  document.getElementById('homeYear').textContent=activeYear;
  const goals=GOALS[activeYear]||{};
  const grid=document.getElementById('activityGrid');
  grid.innerHTML='';

  ACTIVITIES.filter(a=>goals[a.id]).forEach(a=>{
    const goal=goals[a.id], done=countYear(a.id,activeYear);
    const pct=Math.min(100,Math.round(done/goal*100));
    const streaks=getActivityStreaks(a.id);

    // Build streak badges HTML
    let streakHTML='';
    if(streaks.fire>0)   streakHTML+=`<span class="streak-pill fire">ğŸ”¥ ${streaks.fire}</span>`;
    if(streaks.trophy>0) streakHTML+=`<span class="streak-pill trophy">ğŸ† ${streaks.trophy}</span>`;
    if(streaks.bomb>0)   streakHTML+=`<span class="streak-pill bomb">ğŸ’£ ${streaks.bomb}</span>`;

    const card=document.createElement('div');
    card.className='act-card';
    card.innerHTML=`
      <div class="act-streaks">${streakHTML}</div>
      <div class="act-icon">${a.icon}</div>
      <div class="act-name">${a.name}</div>
      <div class="act-count">${done}</div>
      <div class="act-goal">meta: ${goal} dÃ­as</div>
      <div class="act-bar-wrap"><div class="act-bar" style="width:${pct}%"></div></div>
      <div class="act-pct-row">
        <span>${done} de ${goal}</span>
        <span>${pct}%</span>
      </div>`;
    grid.appendChild(card);
  });
}

// â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCalendar(){
  document.getElementById('calTitle').textContent=`${MONTHS_ES[calMonth]} ${calYear}`;
  const grid=document.getElementById('calGrid');
  grid.innerHTML='';
  ['L','M','X','J','V','S','D'].forEach(d=>{
    const c=document.createElement('div');
    c.className='cal-day-name';c.textContent=d;grid.appendChild(c);
  });
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const offset=(firstDay+6)%7;
  const dim=new Date(calYear,calMonth+1,0).getDate();
  const ts=todayStr();
  for(let i=0;i<offset;i++){const c=document.createElement('div');c.className='cal-day empty';grid.appendChild(c);}
  for(let d=1;d<=dim;d++){
    const s=dateStr(calYear,calMonth,d);
    const acts=days[s]||[];
    const wEntry=weights.find(w=>w.date===s);
    const c=document.createElement('div');
    c.className='cal-day';
    if(acts.length>0) c.classList.add('has-data');
    if(s===ts) c.classList.add('today');
    let iconsHtml='';
    acts.forEach(a=>{
      const act=ACTIVITIES.find(x=>x.id===a);
      if(act) iconsHtml+=`<span title="${act.name}">${act.icon}</span>`;
    });
    c.innerHTML=`<div class="day-num">${d}</div>
      <div class="day-icons">${iconsHtml}</div>
      ${wEntry?`<div class="day-wlbl">${wEntry.kg}kg</div>`:''}`;
    c.addEventListener('click',()=>openModal(s));
    grid.appendChild(c);
  }
}
document.getElementById('calPrev').addEventListener('click',()=>{calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderCalendar();});
document.getElementById('calNext').addEventListener('click',()=>{calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderCalendar();});

// â”€â”€ WEIGHT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let weightChart=null;
function renderWeight(){
  const sorted=[...weights].sort((a,b)=>a.date.localeCompare(b.date));
  const labels=sorted.map(w=>{const[y,m,d]=w.date.split('-');return`${d}/${m}/${y.slice(2)}`;});
  const data=sorted.map(w=>w.kg);
  const ctx=document.getElementById('weightChart').getContext('2d');
  if(weightChart) weightChart.destroy();
  const minW=data.length?Math.min(...data)-3:60;
  const maxW=data.length?Math.max(...data)+3:90;

  const colorLinePlugin={
    id:'colorLine',
    afterDatasetsDraw(chart){
      const{ctx:c,scales:{x,y}}=chart;
      const meta=chart.getDatasetMeta(0);
      if(!meta.data.length) return;
      c.save();
      for(let i=0;i<meta.data.length-1;i++){
        const p1=meta.data[i],p2=meta.data[i+1];
        c.beginPath();c.moveTo(p1.x,p1.y);c.lineTo(p2.x,p2.y);
        c.strokeStyle=getZoneColor((data[i]+data[i+1])/2);
        c.lineWidth=3;c.stroke();
      }
      c.restore();
    }
  };

  weightChart=new Chart(ctx,{
    type:'line',
    plugins:[colorLinePlugin],
    data:{
      labels,
      datasets:[
        {
          label:'Peso',data,
          borderColor:'transparent',
          backgroundColor:(ctx2)=>{
            const g=ctx2.chart.ctx.createLinearGradient(0,0,0,280);
            g.addColorStop(0,'rgba(46,204,113,0.2)');
            g.addColorStop(1,'rgba(46,204,113,0)');
            return g;
          },
          pointBackgroundColor:data.map(getZoneColor),
          pointBorderColor:'white',pointBorderWidth:2,
          pointRadius:6,pointHoverRadius:9,
          fill:true,tension:0.35,borderWidth:3,
        },
        {label:'71kg',data:Array(labels.length).fill(71),borderColor:'#2ecc71',borderWidth:1.5,borderDash:[5,4],pointRadius:0,fill:false},
        {label:'77kg',data:Array(labels.length).fill(77),borderColor:'#1a7a3f',borderWidth:1.5,borderDash:[5,4],pointRadius:0,fill:false},
        {label:'78kg',data:Array(labels.length).fill(78),borderColor:'#e74c3c',borderWidth:1.5,borderDash:[5,4],pointRadius:0,fill:false},
      ]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:c=>c.datasetIndex!==0?null:`${c.parsed.y} kg â€” ${getZoneName(c.parsed.y)}`}}
      },
      scales:{
        y:{min:minW,max:maxW,ticks:{callback:v=>v+'kg'},grid:{color:'rgba(0,0,0,0.05)'}},
        x:{ticks:{font:{size:9},maxRotation:45},grid:{display:false}}
      }
    }
  });

  const list=document.getElementById('weightList');
  if(!sorted.length){list.innerHTML='<div class="empty-state"><div class="es-icon">âš–ï¸</div>Sin registros</div>';return;}
  list.innerHTML=[...sorted].reverse().map(w=>{
    const[y,m,d]=w.date.split('-');
    const col=getZoneColor(w.kg),zone=getZoneName(w.kg);
    return`<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 4px;border-bottom:1px solid var(--g4)">
      <span style="font-weight:700;color:var(--gray);font-size:.95rem">${d} ${MONTHS_SHORT[parseInt(m)-1]} ${y}</span>
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:.78rem;font-weight:800;background:${col};color:white;padding:3px 10px;border-radius:99px">${zone}</span>
        <span style="font-family:'Fredoka One',cursive;font-size:1.4rem;color:${col}">${w.kg} kg</span>
      </div></div>`;
  }).join('');
}

// â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHistory(){
  document.getElementById('hYearLabel').textContent=hYear;
  const goals=GOALS[hYear]||{};
  const div=document.getElementById('historyContent');
  const acts=ACTIVITIES.filter(a=>goals[a.id]);
  if(!acts.length){div.innerHTML='<div class="empty-state"><div class="es-icon">ğŸ“Š</div>Sin metas para este aÃ±o</div>';return;}
  div.innerHTML=acts.map(a=>{
    const goal=goals[a.id],done=countYear(a.id,hYear);
    const pct=Math.min(100,Math.round(done/goal*100));
    const col=pct>=100?'#2ecc71':pct>=60?'#1a7a3f':pct>=30?'#f39c12':'#e74c3c';
    return`<div class="hist-row">
      <div class="hist-label">${a.icon} ${a.name}</div>
      <div class="hist-bar-wrap"><div class="hist-bar" style="width:${pct}%;background:${col}"></div></div>
      <div class="hist-val" style="display:flex;flex-direction:column;align-items:flex-end;gap:2px">
        <span>${done}/${goal}</span>
        <span style="font-size:.75rem;color:${col};font-weight:900">${pct}%</span>
      </div></div>`;
  }).join('');
}
document.getElementById('hYearPrev').addEventListener('click',()=>{hYear--;renderHistory();});
document.getElementById('hYearNext').addEventListener('click',()=>{hYear++;renderHistory();});

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(dateOverride){
  const s=dateOverride||todayStr();
  modalDate=s;
  const[y,m,d]=s.split('-');
  document.getElementById('modalDate').textContent=`ğŸ“… ${d} de ${MONTHS_ES[parseInt(m)-1]} de ${y}`;
  const existingActs=days[s]||[];
  const existingW=weights.find(w=>w.date===s);
  document.getElementById('weightInputModal').value=existingW?existingW.kg:'';
  const grid=document.getElementById('modalActGrid');
  grid.innerHTML='';
  ACTIVITIES.forEach(a=>{
    const btn=document.createElement('button');
    btn.className='act-btn'+(existingActs.includes(a.id)?' selected':'');
    btn.dataset.id=a.id;
    btn.innerHTML=`<span class="abi">${a.icon}</span>${a.name}`;
    btn.addEventListener('click',()=>btn.classList.toggle('selected'));
    grid.appendChild(btn);
  });
  document.getElementById('modalOverlay').classList.add('open');
}

document.getElementById('fabBtn').addEventListener('click',()=>openModal());
document.getElementById('modalClose').addEventListener('click',()=>document.getElementById('modalOverlay').classList.remove('open'));
document.getElementById('modalOverlay').addEventListener('click',e=>{
  if(e.target===document.getElementById('modalOverlay')) document.getElementById('modalOverlay').classList.remove('open');
});

document.getElementById('modalSave').addEventListener('click',()=>{
  const selected=[...document.querySelectorAll('.act-btn.selected')].map(b=>b.dataset.id);
  if(selected.length>0) days[modalDate]=selected; else delete days[modalDate];
  saveDays(days);
  const kgVal=parseFloat(document.getElementById('weightInputModal').value);
  if(!isNaN(kgVal)&&kgVal>0){
    weights=weights.filter(w=>w.date!==modalDate);
    weights.push({date:modalDate,kg:kgVal});
    saveWeights(weights);
  }
  document.getElementById('modalOverlay').classList.remove('open');
  renderHome();
  if(document.getElementById('page-calendar').classList.contains('active')) renderCalendar();
  if(document.getElementById('page-weight').classList.contains('active'))   renderWeight();
});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderHome();
renderCalendar();
</script>
</body>
</html>
